<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>父窗口 - iframe PostMessage 测试</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            height: 80vh;
        }

        .iframe-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .control-panel {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .status {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            font-family: monospace;
            font-size: 14px;
        }

        .message-log {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }

        .log-entry {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
        }

        .log-received {
            background: rgba(76, 175, 80, 0.2);
            border-left: 3px solid #4CAF50;
        }

        .log-sent {
            background: rgba(33, 150, 243, 0.2);
            border-left: 3px solid #2196F3;
        }

        .log-error {
            background: rgba(244, 67, 54, 0.2);
            border-left: 3px solid #F44336;
        }

        @media (max-width: 768px) {
            .layout {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🖼️ iframe PostMessage 通信测试</h1>
        
        <div class="layout">
            <!-- iframe 容器 -->
            <div class="iframe-container">
                <iframe 
                    id="testIframe"
                    src="http://localhost:3000/iframe"
                    title="Color Messenger iframe">
                </iframe>
            </div>

            <!-- 控制面板 -->
            <div class="control-panel">
                <h2>📊 父窗口控制面板</h2>
                
                <div class="status" id="status">
                    <div>状态: 等待消息...</div>
                    <div>接收到的消息: 0</div>
                    <div>发送的响应: 0</div>
                </div>

                <h3>📝 消息日志</h3>
                <div class="message-log" id="messageLog"></div>
            </div>
        </div>
    </div>

    <script>
        let receivedCount = 0;
        let sentCount = 0;
        const messageLog = document.getElementById('messageLog');
        const statusDiv = document.getElementById('status');

        // 更新状态显示
        function updateStatus(status = '运行中...') {
            statusDiv.innerHTML = `
                <div>状态: ${status}</div>
                <div>接收到的消息: ${receivedCount}</div>
                <div>发送的响应: ${sentCount}</div>
            `;
        }

        // 添加日志条目
        function addLogEntry(type, message) {
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            messageLog.appendChild(entry);
            messageLog.scrollTop = messageLog.scrollHeight;
        }

        // 生成彩色图片URL（使用 placeholder.com）
        function generateColorImage(color) {
            // 移除颜色字符串中的 # 符号
            const cleanColor = color.replace('#', '');
            const width = 400;
            const height = 300;
            
            // 使用 placeholder.com 生成彩色图片
            const imageUrl = `https://via.placeholder.com/${width}x${height}/${cleanColor}/${cleanColor}?text=Generated+Image`;
            
            return imageUrl;
        }

        // 模拟异步图片生成过程
        async function processColorRequest(eventData) {
            const { eventId, payload } = eventData;
            const color = payload.color;

            try {
                addLogEntry('received', `处理颜色请求: ${color} (eventId: ${eventId})`);
                
                // 模拟处理延迟
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // 生成图片URL
                const imageUrl = generateColorImage(color);
                
                // 构建响应消息
                const response = {
                    type: 'IFRAME_EVENT_RESPONSE',
                    eventId: eventId,
                    success: true,
                    data: {
                        imageUrl: imageUrl,
                        color: color,
                        generatedAt: new Date().toISOString(),
                    }
                };

                // 发送响应到 iframe
                const iframe = document.getElementById('testIframe');
                if (iframe && iframe.contentWindow) {
                    iframe.contentWindow.postMessage(response, 'http://localhost:3000');
                    sentCount++;
                    addLogEntry('sent', `发送图片URL: ${imageUrl}`);
                    updateStatus('已发送响应');
                } else {
                    throw new Error('无法访问 iframe');
                }

            } catch (error) {
                console.error('处理颜色请求失败:', error);
                
                // 发送错误响应
                const errorResponse = {
                    type: 'IFRAME_EVENT_RESPONSE',
                    eventId: eventId,
                    success: false,
                    error: `图片生成失败: ${error.message}`
                };

                const iframe = document.getElementById('testIframe');
                if (iframe && iframe.contentWindow) {
                    iframe.contentWindow.postMessage(errorResponse, 'http://localhost:3000');
                    sentCount++;
                    addLogEntry('error', `发送错误响应: ${error.message}`);
                    updateStatus('发送错误响应');
                }
            }
        }

        // 监听来自 iframe 的消息
        window.addEventListener('message', async (event) => {
            // 安全检查：验证消息来源
            if (event.origin !== 'http://localhost:3000') {
                addLogEntry('error', `拒绝来自 ${event.origin} 的消息`);
                return;
            }

            // 检查消息格式
            if (event.data && event.data.type === 'IFRAME_EVENT') {
                receivedCount++;
                const eventData = event.data;
                
                addLogEntry('received', `收到 iframe 消息: ${JSON.stringify(eventData, null, 2)}`);
                updateStatus('正在处理消息...');

                // 根据 action 类型处理消息
                switch (eventData.action) {
                    case 'color_selected':
                        await processColorRequest(eventData);
                        break;
                    
                    default:
                        addLogEntry('error', `未知的 action 类型: ${eventData.action}`);
                        
                        // 发送不支持的操作响应
                        const unsupportedResponse = {
                            type: 'IFRAME_EVENT_RESPONSE',
                            eventId: eventData.eventId,
                            success: false,
                            error: `不支持的操作: ${eventData.action}`
                        };

                        const iframe = document.getElementById('testIframe');
                        if (iframe && iframe.contentWindow) {
                            iframe.contentWindow.postMessage(unsupportedResponse, 'http://localhost:3000');
                            sentCount++;
                            updateStatus('发送不支持响应');
                        }
                        break;
                }
            } else {
                addLogEntry('error', `收到未知格式的消息: ${JSON.stringify(event.data)}`);
            }
        });

        // iframe 加载完成后的初始化
        document.getElementById('testIframe').addEventListener('load', () => {
            addLogEntry('received', 'iframe 加载完成，准备接收消息');
            updateStatus('iframe 已加载');
        });

        // 页面加载完成
        window.addEventListener('load', () => {
            addLogEntry('received', '父窗口初始化完成');
            updateStatus('等待 iframe 加载...');
        });
    </script>
</body>
</html>