<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çˆ¶çª—å£ - iframe PostMessage æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            height: 80vh;
        }

        .iframe-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .control-panel {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .status {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            font-family: monospace;
            font-size: 14px;
        }

        .message-log {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }

        .log-entry {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
        }

        .log-received {
            background: rgba(76, 175, 80, 0.2);
            border-left: 3px solid #4CAF50;
        }

        .log-sent {
            background: rgba(33, 150, 243, 0.2);
            border-left: 3px solid #2196F3;
        }

        .log-error {
            background: rgba(244, 67, 54, 0.2);
            border-left: 3px solid #F44336;
        }

        @media (max-width: 768px) {
            .layout {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ–¼ï¸ iframe PostMessage é€šä¿¡æµ‹è¯•</h1>
        
        <div class="layout">
            <!-- iframe å®¹å™¨ -->
            <div class="iframe-container">
                <iframe 
                    id="testIframe"
                    src="http://localhost:3000/iframe"
                    title="Color Messenger iframe">
                </iframe>
            </div>

            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="control-panel">
                <h2>ğŸ“Š çˆ¶çª—å£æ§åˆ¶é¢æ¿</h2>
                
                <div class="status" id="status">
                    <div>çŠ¶æ€: ç­‰å¾…æ¶ˆæ¯...</div>
                    <div>æ¥æ”¶åˆ°çš„æ¶ˆæ¯: 0</div>
                    <div>å‘é€çš„å“åº”: 0</div>
                </div>

                <h3>ğŸ“ æ¶ˆæ¯æ—¥å¿—</h3>
                <div class="message-log" id="messageLog"></div>
            </div>
        </div>
    </div>

    <script>
        let receivedCount = 0;
        let sentCount = 0;
        const messageLog = document.getElementById('messageLog');
        const statusDiv = document.getElementById('status');

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(status = 'è¿è¡Œä¸­...') {
            statusDiv.innerHTML = `
                <div>çŠ¶æ€: ${status}</div>
                <div>æ¥æ”¶åˆ°çš„æ¶ˆæ¯: ${receivedCount}</div>
                <div>å‘é€çš„å“åº”: ${sentCount}</div>
            `;
        }

        // æ·»åŠ æ—¥å¿—æ¡ç›®
        function addLogEntry(type, message) {
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            messageLog.appendChild(entry);
            messageLog.scrollTop = messageLog.scrollHeight;
        }

        // ç”Ÿæˆå½©è‰²å›¾ç‰‡URLï¼ˆä½¿ç”¨ placeholder.comï¼‰
        function generateColorImage(color) {
            // ç§»é™¤é¢œè‰²å­—ç¬¦ä¸²ä¸­çš„ # ç¬¦å·
            const cleanColor = color.replace('#', '');
            const width = 400;
            const height = 300;
            
            // ä½¿ç”¨ placeholder.com ç”Ÿæˆå½©è‰²å›¾ç‰‡
            const imageUrl = `https://via.placeholder.com/${width}x${height}/${cleanColor}/${cleanColor}?text=Generated+Image`;
            
            return imageUrl;
        }

        // æ¨¡æ‹Ÿå¼‚æ­¥å›¾ç‰‡ç”Ÿæˆè¿‡ç¨‹
        async function processColorRequest(eventData) {
            const { eventId, payload } = eventData;
            const color = payload.color;

            try {
                addLogEntry('received', `å¤„ç†é¢œè‰²è¯·æ±‚: ${color} (eventId: ${eventId})`);
                
                // æ¨¡æ‹Ÿå¤„ç†å»¶è¿Ÿ
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // ç”Ÿæˆå›¾ç‰‡URL
                const imageUrl = generateColorImage(color);
                
                // æ„å»ºå“åº”æ¶ˆæ¯
                const response = {
                    type: 'IFRAME_EVENT_RESPONSE',
                    eventId: eventId,
                    success: true,
                    data: {
                        imageUrl: imageUrl,
                        color: color,
                        generatedAt: new Date().toISOString(),
                    }
                };

                // å‘é€å“åº”åˆ° iframe
                const iframe = document.getElementById('testIframe');
                if (iframe && iframe.contentWindow) {
                    iframe.contentWindow.postMessage(response, 'http://localhost:3000');
                    sentCount++;
                    addLogEntry('sent', `å‘é€å›¾ç‰‡URL: ${imageUrl}`);
                    updateStatus('å·²å‘é€å“åº”');
                } else {
                    throw new Error('æ— æ³•è®¿é—® iframe');
                }

            } catch (error) {
                console.error('å¤„ç†é¢œè‰²è¯·æ±‚å¤±è´¥:', error);
                
                // å‘é€é”™è¯¯å“åº”
                const errorResponse = {
                    type: 'IFRAME_EVENT_RESPONSE',
                    eventId: eventId,
                    success: false,
                    error: `å›¾ç‰‡ç”Ÿæˆå¤±è´¥: ${error.message}`
                };

                const iframe = document.getElementById('testIframe');
                if (iframe && iframe.contentWindow) {
                    iframe.contentWindow.postMessage(errorResponse, 'http://localhost:3000');
                    sentCount++;
                    addLogEntry('error', `å‘é€é”™è¯¯å“åº”: ${error.message}`);
                    updateStatus('å‘é€é”™è¯¯å“åº”');
                }
            }
        }

        // ç›‘å¬æ¥è‡ª iframe çš„æ¶ˆæ¯
        window.addEventListener('message', async (event) => {
            // å®‰å…¨æ£€æŸ¥ï¼šéªŒè¯æ¶ˆæ¯æ¥æº
            if (event.origin !== 'http://localhost:3000') {
                addLogEntry('error', `æ‹’ç»æ¥è‡ª ${event.origin} çš„æ¶ˆæ¯`);
                return;
            }

            // æ£€æŸ¥æ¶ˆæ¯æ ¼å¼
            if (event.data && event.data.type === 'IFRAME_EVENT') {
                receivedCount++;
                const eventData = event.data;
                
                addLogEntry('received', `æ”¶åˆ° iframe æ¶ˆæ¯: ${JSON.stringify(eventData, null, 2)}`);
                updateStatus('æ­£åœ¨å¤„ç†æ¶ˆæ¯...');

                // æ ¹æ® action ç±»å‹å¤„ç†æ¶ˆæ¯
                switch (eventData.action) {
                    case 'color_selected':
                        await processColorRequest(eventData);
                        break;
                    
                    default:
                        addLogEntry('error', `æœªçŸ¥çš„ action ç±»å‹: ${eventData.action}`);
                        
                        // å‘é€ä¸æ”¯æŒçš„æ“ä½œå“åº”
                        const unsupportedResponse = {
                            type: 'IFRAME_EVENT_RESPONSE',
                            eventId: eventData.eventId,
                            success: false,
                            error: `ä¸æ”¯æŒçš„æ“ä½œ: ${eventData.action}`
                        };

                        const iframe = document.getElementById('testIframe');
                        if (iframe && iframe.contentWindow) {
                            iframe.contentWindow.postMessage(unsupportedResponse, 'http://localhost:3000');
                            sentCount++;
                            updateStatus('å‘é€ä¸æ”¯æŒå“åº”');
                        }
                        break;
                }
            } else {
                addLogEntry('error', `æ”¶åˆ°æœªçŸ¥æ ¼å¼çš„æ¶ˆæ¯: ${JSON.stringify(event.data)}`);
            }
        });

        // iframe åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.getElementById('testIframe').addEventListener('load', () => {
            addLogEntry('received', 'iframe åŠ è½½å®Œæˆï¼Œå‡†å¤‡æ¥æ”¶æ¶ˆæ¯');
            updateStatus('iframe å·²åŠ è½½');
        });

        // é¡µé¢åŠ è½½å®Œæˆ
        window.addEventListener('load', () => {
            addLogEntry('received', 'çˆ¶çª—å£åˆå§‹åŒ–å®Œæˆ');
            updateStatus('ç­‰å¾… iframe åŠ è½½...');
        });
    </script>
</body>
</html>